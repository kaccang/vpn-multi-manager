#!/bin/bash

##############################################
# VPN Multi-Profile System - Profile Stats
##############################################

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

BASE_DIR="/opt/vpn-multi"
PROFILES_DIR="$BASE_DIR/profiles"

if [ -z "$1" ]; then
    echo -e "${RED}Usage: profile-stats <profile-name>${NC}"
    exit 1
fi

profile_name="$1"
profile_dir="$PROFILES_DIR/$profile_name"

if [ ! -d "$profile_dir" ]; then
    echo -e "${RED}Error: Profile '$profile_name' not found!${NC}"
    exit 1
fi

# Load profile config
if [ ! -f "$profile_dir/profile.conf" ]; then
    echo -e "${RED}Error: Profile configuration not found!${NC}"
    exit 1
fi

source "$profile_dir/profile.conf"

container_name="vpn-${profile_name}"

# Check if container is running
if ! docker ps --format '{{.Names}}' | grep -q "^${container_name}$"; then
    echo -e "${RED}Error: Container '$container_name' is not running!${NC}"
    exit 1
fi

clear
echo -e "${CYAN}╔══════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║                                                      ║${NC}"
echo -e "${CYAN}║           PROFILE STATISTICS                         ║${NC}"
echo -e "${CYAN}║                                                      ║${NC}"
echo -e "${CYAN}╚══════════════════════════════════════════════════════╝${NC}"
echo ""

# Profile Info
echo -e "${YELLOW}Profile Information:${NC}"
echo -e "  Name          : ${GREEN}$PROFILE_NAME${NC}"
echo -e "  Domain        : ${GREEN}$DOMAIN${NC}"
echo -e "  Created At    : ${GREEN}$CREATED_AT${NC}"
echo -e "  SSH Port      : ${GREEN}$SSH_PORT${NC}"
echo ""

# Resource Limits
echo -e "${YELLOW}Resource Limits:${NC}"
echo -e "  CPU Limit     : ${GREEN}${CPU_PERCENT}%${NC}"
echo -e "  RAM Limit     : ${GREEN}${RAM_MB}MB${NC}"
echo ""

# Container Stats
echo -e "${YELLOW}Current Usage:${NC}"
docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}" | grep "$container_name" | awk '{print "  CPU Usage     : \033[0;32m" $2 "\033[0m\n  Memory Usage  : \033[0;32m" $3 "\033[0m\n  Network I/O   : \033[0;32m" $4 " " $5 " " $6 "\033[0m\n  Block I/O     : \033[0;32m" $7 " " $8 " " $9 "\033[0m"}'
echo ""

# VPN Account Count
echo -e "${YELLOW}VPN Accounts:${NC}"
vmess_count=$(docker exec $container_name grep -c '^###' /etc/xray/config.json 2>/dev/null || echo 0)
vless_count=$(docker exec $container_name grep -c '^#&' /etc/xray/config.json 2>/dev/null || echo 0)
trojan_count=$(docker exec $container_name grep -c '^#!' /etc/xray/config.json 2>/dev/null || echo 0)

echo -e "  VMess Accounts  : ${GREEN}$vmess_count${NC}"
echo -e "  VLess Accounts  : ${GREEN}$vless_count${NC}"
echo -e "  Trojan Accounts : ${GREEN}$trojan_count${NC}"
echo ""

# Container Status
echo -e "${YELLOW}Container Status:${NC}"
uptime=$(docker inspect --format='{{.State.StartedAt}}' $container_name 2>/dev/null)
echo -e "  Started At    : ${GREEN}$uptime${NC}"
echo -e "  Status        : ${GREEN}Running${NC}"
echo ""

echo -e "${CYAN}══════════════════════════════════════════════════════${NC}"
