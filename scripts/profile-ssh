#!/bin/bash

##############################################
# Profile SSH - Passwordless SSH to Profile
##############################################

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

BASE_DIR="/opt/vpn-multi"
PROFILES_DIR="$BASE_DIR/profiles"

# Usage
if [ -z "$1" ]; then
    echo -e "${CYAN}Usage:${NC}"
    echo "  profile-ssh <profile-name>          - SSH to specific profile"
    echo "  profile-ssh                          - Interactive selection"
    echo ""
    echo -e "${YELLOW}Example:${NC}"
    echo "  profile-ssh asep1"
    exit 0
fi

profile_name="$1"
profile_dir="$PROFILES_DIR/$profile_name"

# Check if profile exists
if [ ! -d "$profile_dir" ]; then
    echo -e "${RED}Error: Profile '$profile_name' not found!${NC}"
    echo ""
    echo -e "${YELLOW}Available profiles:${NC}"
    ls -1 "$PROFILES_DIR" 2>/dev/null | head -10
    exit 1
fi

# Load profile config
if [ ! -f "$profile_dir/profile.conf" ]; then
    echo -e "${RED}Error: Profile configuration not found!${NC}"
    exit 1
fi

source "$profile_dir/profile.conf"

# Check if container is running
container_name="vpn-${PROFILE_NAME}"
if ! docker ps --format '{{.Names}}' | grep -q "^${container_name}$"; then
    echo -e "${RED}Error: Container '$container_name' is not running!${NC}"
    echo -e "${YELLOW}Start it with: cd $profile_dir && docker-compose start${NC}"
    exit 1
fi

# SSH using key (passwordless)
echo -e "${GREEN}Connecting to profile '$PROFILE_NAME' (passwordless)...${NC}"
ssh -o StrictHostKeyChecking=no root@localhost -p $SSH_PORT
