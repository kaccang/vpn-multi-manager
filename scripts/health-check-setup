#!/bin/bash

##############################################
# Health Check Configuration Setup
##############################################

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m'

CONFIG_FILE="/opt/vpn-multi/health-check.conf"

clear
echo -e "${CYAN}╔══════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║                                                      ║${NC}"
echo -e "${CYAN}║      HEALTH CHECK TELEGRAM CONFIGURATION             ║${NC}"
echo -e "${CYAN}║                                                      ║${NC}"
echo -e "${CYAN}╚══════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${YELLOW}Setup Telegram notifications for profile health monitoring.${NC}"
echo ""
echo -e "${CYAN}Step 1: Create Telegram Bot${NC}"
echo "  1. Open Telegram and search for @BotFather"
echo "  2. Send /newbot and follow instructions"
echo "  3. Copy the Bot Token"
echo ""
echo -e "${CYAN}Step 2: Get Your Chat ID${NC}"
echo "  1. Search for @userinfobot in Telegram"
echo "  2. Start chat and get your Chat ID"
echo ""
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Input Telegram Bot Token
read -p "$(echo -e ${YELLOW}Enter Telegram Bot Token:${NC}) " bot_token

if [ -z "$bot_token" ]; then
    echo -e "${RED}Bot token cannot be empty!${NC}"
    exit 1
fi

# Input Chat ID
read -p "$(echo -e ${YELLOW}Enter Telegram Chat ID:${NC}) " chat_id

if [ -z "$chat_id" ]; then
    echo -e "${RED}Chat ID cannot be empty!${NC}"
    exit 1
fi

# Save configuration
cat > "$CONFIG_FILE" <<EOF
# Telegram Health Check Configuration
TELEGRAM_BOT_TOKEN="$bot_token"
TELEGRAM_CHAT_ID="$chat_id"
EOF

echo ""
echo -e "${GREEN}Configuration saved!${NC}"
echo ""

# Test notification
echo -e "${YELLOW}Sending test notification...${NC}"
test_message="<b>✅ Health Check Configured</b>

VPN Multi-Profile health monitoring is now active.

You will receive notifications when:
• Profile goes DOWN
• Profile comes back UP
• Profile remains down (every 30 minutes)

Time: $(date '+%Y-%m-%d %H:%M:%S')"

curl -s -X POST "https://api.telegram.org/bot${bot_token}/sendMessage" \
    -d "chat_id=${chat_id}" \
    -d "text=${test_message}" \
    -d "parse_mode=HTML" > /dev/null 2>&1

if [ $? -eq 0 ]; then
    echo -e "${GREEN}✓ Test notification sent successfully!${NC}"
    echo -e "${GREEN}Check your Telegram for the test message.${NC}"
else
    echo -e "${RED}✗ Failed to send test notification.${NC}"
    echo -e "${RED}Please check your Bot Token and Chat ID.${NC}"
    exit 1
fi

# Setup cron job
echo ""
echo -e "${YELLOW}Setting up cron job for health check (every 5 minutes)...${NC}"

# Remove old cron job if exists
crontab -l 2>/dev/null | grep -v "health-check" | crontab - 2>/dev/null

# Add new cron job
(crontab -l 2>/dev/null; echo "*/5 * * * * /opt/vpn-multi/scripts/health-check") | crontab -

echo -e "${GREEN}✓ Cron job configured!${NC}"

echo ""
echo -e "${CYAN}═══════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}Health check monitoring is now active!${NC}"
echo -e "${CYAN}═══════════════════════════════════════════════════════${NC}"
echo ""
echo -e "${YELLOW}Monitoring interval:${NC} Every 5 minutes"
echo -e "${YELLOW}Configuration file:${NC} $CONFIG_FILE"
echo -e "${YELLOW}Log file:${NC} /opt/vpn-multi/logs/health-check.log"
echo ""
