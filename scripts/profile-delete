#!/bin/bash

##############################################
# VPN Multi-Profile System - Delete Profile
##############################################

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

BASE_DIR="/opt/vpn-multi"
PROFILES_DIR="$BASE_DIR/profiles"
HISTORY_FILE="$BASE_DIR/history.md"

# Check root
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}Error: This script must be run as root!${NC}"
    exit 1
fi

if [ -z "$1" ]; then
    echo -e "${RED}Usage: profile-delete <profile-name>${NC}"
    exit 1
fi

profile_name="$1"
profile_dir="$PROFILES_DIR/$profile_name"

if [ ! -d "$profile_dir" ]; then
    echo -e "${RED}Error: Profile '$profile_name' not found!${NC}"
    exit 1
fi

clear
echo -e "${CYAN}╔══════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║                                                      ║${NC}"
echo -e "${CYAN}║           DELETE VPN PROFILE                         ║${NC}"
echo -e "${CYAN}║                                                      ║${NC}"
echo -e "${CYAN}╚══════════════════════════════════════════════════════╝${NC}"
echo ""

# Load profile info
if [ -f "$profile_dir/profile.conf" ]; then
    source "$profile_dir/profile.conf"
    echo -e "${YELLOW}Profile to delete:${NC}"
    echo -e "  Name     : ${RED}$PROFILE_NAME${NC}"
    echo -e "  Domain   : ${RED}$DOMAIN${NC}"
    echo -e "  SSH Port : ${RED}$SSH_PORT${NC}"
    echo ""
fi

echo -e "${RED}WARNING: This will permanently delete the profile and all its data!${NC}"
echo -e "${RED}This action cannot be undone!${NC}"
echo ""

# Confirmation
while true; do
    read -p "$(echo -e ${YELLOW}Type profile name to confirm deletion:${NC}) " confirm_name
    if [ "$confirm_name" = "$profile_name" ]; then
        break
    else
        echo -e "${RED}Profile name doesn't match! Please try again.${NC}"
    fi
done

echo ""
echo -e "${YELLOW}Deleting profile '$profile_name'...${NC}"

# Stop and remove container
container_name="vpn-${profile_name}"
if docker ps -a --format '{{.Names}}' | grep -q "^${container_name}$"; then
    echo -e "${YELLOW}[1/3] Stopping and removing container...${NC}"
    cd "$profile_dir"
    docker-compose down -v 2>/dev/null
    docker rm -f $container_name 2>/dev/null
    echo -e "${GREEN}Container removed!${NC}"
fi

# Remove profile directory
echo -e "${YELLOW}[2/3] Removing profile directory...${NC}"
rm -rf "$profile_dir"
echo -e "${GREEN}Profile directory removed!${NC}"

# Log to history
echo -e "${YELLOW}[3/3] Updating history...${NC}"
cat >> "$HISTORY_FILE" << EOF

## $(date +"%Y-%m-%d %H:%M:%S")

**User Request:**
> Delete profile '$profile_name'

**Action:**
- Stopped and removed Docker container: $container_name
- Removed profile directory: $profile_dir
- Cleaned up all associated data

**AI Response:**
Profile '$profile_name' berhasil dihapus dari sistem. Container dan semua data terkait telah dihapus.

**Status:** ✅ Success

---
EOF

echo -e "${GREEN}History updated!${NC}"

echo ""
echo -e "${GREEN}╔══════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║                                                      ║${NC}"
echo -e "${GREEN}║        PROFILE DELETED SUCCESSFULLY!                 ║${NC}"
echo -e "${GREEN}║                                                      ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${CYAN}Profile '$profile_name' has been deleted.${NC}"
echo ""
