#!/bin/bash

clear
CONFIG="/etc/xray/config.json"
DOMAIN=$(cat /etc/xray/domain)

echo -e "\033[1;36m╔══════════════════════════════════════════╗\033[0m"
echo -e "\033[1;36m║          ADD VLESS ACCOUNT               ║\033[0m"
echo -e "\033[1;36m╚══════════════════════════════════════════╝\033[0m"
echo ""

# Input username
until [[ $user =~ ^[a-zA-Z0-9_]+$ && ${CLIENT_EXISTS} == '0' ]]; do
    read -rp "Username: " -e user
    CLIENT_EXISTS=$(grep -w "#& $user" "$CONFIG" | wc -l)

    if [[ ${CLIENT_EXISTS} == '1' ]]; then
        echo -e "\033[1;31mUsername already exists! Choose another name.\033[0m"
        echo ""
    fi
done

# Generate UUID
uuid=$(cat /proc/sys/kernel/random/uuid)

# Input expiry days
read -p "Expired (days): " masaaktif
exp=$(date -d "$masaaktif days" +"%Y-%m-%d")

# Add to config
sed -i "/#vless$/a\#& $user $exp\n},{ \"id\": \"$uuid\", \"email\": \"$user\"" "$CONFIG"

# Generate VLess link
vlesslink="vless://${uuid}@${DOMAIN}:443?path=/vless&security=tls&encryption=none&type=ws&host=${DOMAIN}#${user}"

clear
echo -e "\033[1;32m═══════════════════════════════════════════\033[0m"
echo -e "\033[1;32m         VLESS ACCOUNT CREATED             \033[0m"
echo -e "\033[1;32m═══════════════════════════════════════════\033[0m"
echo -e "Username    : \033[1;33m$user\033[0m"
echo -e "Domain      : \033[1;33m$DOMAIN\033[0m"
echo -e "Port        : \033[1;33m443\033[0m"
echo -e "UUID        : \033[1;33m$uuid\033[0m"
echo -e "Encryption  : \033[1;33mnone\033[0m"
echo -e "Network     : \033[1;33mWebSocket\033[0m"
echo -e "Path        : \033[1;33m/vless\033[0m"
echo -e "Security    : \033[1;33mTLS\033[0m"
echo -e "Expired On  : \033[1;33m$exp\033[0m"
echo -e "\033[1;32m═══════════════════════════════════════════\033[0m"
echo ""
echo -e "\033[1;36mVLess Link:\033[0m"
echo "$vlesslink"
echo -e "\033[1;32m═══════════════════════════════════════════\033[0m"

# Restart Xray
pkill xray
/usr/local/bin/xray run -config /etc/xray/config.json &

echo ""
read -n 1 -s -r -p "Press any key to return to menu..."
/root/scripts/menu
