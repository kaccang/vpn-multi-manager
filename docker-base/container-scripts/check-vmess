#!/bin/bash

clear
CONFIG="/etc/xray/config.json"
DOMAIN=$(cat /etc/xray/domain)

echo -e "\033[1;36m╔══════════════════════════════════════════╗\033[0m"
echo -e "\033[1;36m║         CHECK VMESS ACCOUNT              ║\033[0m"
echo -e "\033[1;36m╚══════════════════════════════════════════╝\033[0m"
echo ""

mapfile -t entries < <(grep -E '^###' "$CONFIG" | awk '!seen[$2]++')

if [ ${#entries[@]} -eq 0 ]; then
    echo "No VMess accounts found."
    read -n 1 -s -r -p "Press any key to return to menu..."
    /root/scripts/menu
    exit 0
fi

for i in "${!entries[@]}"; do
    user=$(echo "${entries[$i]}" | awk '{print $2}')
    exp=$(echo "${entries[$i]}" | awk '{print $3}')
    printf "  %2d. %-20s (Exp: %s)\n" $((i+1)) "$user" "$exp"
done

echo ""
read -p "Select account [1-${#entries[@]}]: " num

if [ "$num" -lt 1 ] || [ "$num" -gt ${#entries[@]} ]; then
    echo "Invalid!"
    sleep 2
    /root/scripts/menu
    exit 1
fi

line="${entries[$((num-1))]}"
user=$(echo "$line" | awk '{print $2}')
exp=$(echo "$line" | awk '{print $3}')
uuid=$(grep -A1 -E "^### $user " "$CONFIG" | grep -oP '"id":\s*"\K[^"]+' | head -n 1)

VMESS_WS=$(cat<<EOF
{
  "v": "2",
  "ps": "$user TLS",
  "add": "$DOMAIN",
  "port": "443",
  "id": "$uuid",
  "aid": "0",
  "net": "ws",
  "path": "/vmess",
  "type": "none",
  "host": "$DOMAIN",
  "tls": "tls"
}
EOF
)

VMESS_NON_TLS=$(cat<<EOF
{
  "v": "2",
  "ps": "$user NTLS",
  "add": "$DOMAIN",
  "port": "80",
  "id": "$uuid",
  "aid": "0",
  "net": "ws",
  "path": "/vmess",
  "type": "none",
  "host": "$DOMAIN",
  "tls": "none"
}
EOF
)

vmesslink1="vmess://$(echo $VMESS_WS | base64 -w 0)"
vmesslink2="vmess://$(echo $VMESS_NON_TLS | base64 -w 0)"

clear
echo -e "\033[1;32m═══════════════════════════════════════════\033[0m"
echo -e "\033[1;32m         VMESS ACCOUNT DETAILS             \033[0m"
echo -e "\033[1;32m═══════════════════════════════════════════\033[0m"
echo -e "User        : \033[1;33m$user\033[0m"
echo -e "Domain      : \033[1;33m$DOMAIN\033[0m"
echo -e "Port TLS    : \033[1;33m443\033[0m"
echo -e "Port Non-TLS: \033[1;33m80\033[0m"
echo -e "UUID        : \033[1;33m$uuid\033[0m"
echo -e "Path        : \033[1;33m/vmess\033[0m"
echo -e "Expired     : \033[1;33m$exp\033[0m"
echo -e "\033[1;32m═══════════════════════════════════════════\033[0m"
echo ""
echo -e "\033[1;36mTLS Link:\033[0m"
echo "$vmesslink1"
echo ""
echo -e "\033[1;36mNon-TLS Link:\033[0m"
echo "$vmesslink2"
echo -e "\033[1;32m═══════════════════════════════════════════\033[0m"

echo ""
read -n 1 -s -r -p "Press any key to return to menu..."
/root/scripts/menu
