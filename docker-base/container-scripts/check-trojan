#!/bin/bash

clear
CONFIG="/etc/xray/config.json"
DOMAIN=$(cat /etc/xray/domain)

echo -e "\033[1;36m╔══════════════════════════════════════════╗\033[0m"
echo -e "\033[1;36m║         CHECK TROJAN ACCOUNT             ║\033[0m"
echo -e "\033[1;36m╚══════════════════════════════════════════╝\033[0m"
echo ""

mapfile -t entries < <(grep -E '^#!' "$CONFIG" | awk '!seen[$2]++')

if [ ${#entries[@]} -eq 0 ]; then
    echo "No Trojan accounts found."
    read -n 1 -s -r -p "Press any key to return to menu..."
    /root/scripts/menu
    exit 0
fi

for i in "${!entries[@]}"; do
    user=$(echo "${entries[$i]}" | awk '{print $2}')
    exp=$(echo "${entries[$i]}" | awk '{print $3}')
    printf "  %2d. %-20s (Exp: %s)\n" $((i+1)) "$user" "$exp"
done

echo ""
read -p "Select account [1-${#entries[@]}]: " num

if [ "$num" -lt 1 ] || [ "$num" -gt ${#entries[@]} ]; then
    echo "Invalid!"
    sleep 2
    /root/scripts/menu
    exit 1
fi

line="${entries[$((num-1))]}"
user=$(echo "$line" | awk '{print $2}')
exp=$(echo "$line" | awk '{print $3}')
password=$(grep -A1 -E "^#! $user " "$CONFIG" | grep -oP '"password":\s*"\K[^"]+' | head -n 1)

trojanlink="trojan://${password}@${DOMAIN}:443?path=/trojan-ws&security=tls&type=ws&host=${DOMAIN}#${user}"

clear
echo -e "\033[1;32m═══════════════════════════════════════════\033[0m"
echo -e "\033[1;32m        TROJAN ACCOUNT DETAILS             \033[0m"
echo -e "\033[1;32m═══════════════════════════════════════════\033[0m"
echo -e "User        : \033[1;33m$user\033[0m"
echo -e "Domain      : \033[1;33m$DOMAIN\033[0m"
echo -e "Port        : \033[1;33m443\033[0m"
echo -e "Password    : \033[1;33m$password\033[0m"
echo -e "Path        : \033[1;33m/trojan-ws\033[0m"
echo -e "Security    : \033[1;33mTLS\033[0m"
echo -e "Expired     : \033[1;33m$exp\033[0m"
echo -e "\033[1;32m═══════════════════════════════════════════\033[0m"
echo ""
echo -e "\033[1;36mTrojan Link:\033[0m"
echo "$trojanlink"
echo -e "\033[1;32m═══════════════════════════════════════════\033[0m"

echo ""
read -n 1 -s -r -p "Press any key to return to menu..."
/root/scripts/menu
